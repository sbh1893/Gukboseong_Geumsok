# -*- coding: utf-8 -*-
"""ex01.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1QfYSbuJJcC_3sRlgyj1nTBlYTFyarnWr
"""

import streamlit as st
import pandas as pd
import io
from openpyxl import load_workbook
from openpyxl.styles import Alignment, Border, Side, PatternFill, Font

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ì—‘ì…€ ìë™ ì •ë¦¬ê¸°", layout="wide")

st.title("ğŸ“Š ì‚¬ê¸‰ ëª©ë¡ ì—‘ì…€ ìë™ ì •ë¦¬ê¸°")
st.write("ì—‘ì…€ ë˜ëŠ” CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´, ì—…ì²´ë³„/ì¼ìë³„ë¡œ ì •ë¦¬í•˜ê³  ì„œì‹ì„ ì ìš©í•´ì¤ë‹ˆë‹¤.")

# 1. íŒŒì¼ ì—…ë¡œë“œ ìœ„ì ¯
uploaded_file = st.file_uploader("ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì—…ë¡œë“œí•˜ì„¸ìš”.", type=['xlsx', 'csv'])

if uploaded_file is not None:
    st.success("íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ! ë³€í™˜ì„ ì‹œì‘í•©ë‹ˆë‹¤...")

    # 2. ë°ì´í„° ì½ê¸° (ë§ŒëŠ¥ ë¡œë” í•¨ìˆ˜)
    @st.cache_data # ì†ë„ í–¥ìƒì„ ìœ„í•´ ìºì‹±
    def load_data(file):
        df = None
        # íŒŒì¼ í¬ì¸í„°ë¥¼ ì²˜ìŒìœ¼ë¡œ ë˜ëŒë¦¼ (ì¤‘ìš”)
        file.seek(0)

        # 1ì°¨ ì‹œë„: ì—‘ì…€ë¡œ ì½ê¸°
        try:
            df = pd.read_excel(file, header=2)
            return df, "Excel"
        except:
            pass

        # 2ì°¨ ì‹œë„: CSVë¡œ ì½ê¸°
        encodings = ['utf-8', 'cp949', 'euc-kr']
        for enc in encodings:
            try:
                file.seek(0)
                df = pd.read_csv(file, header=2, encoding=enc)
                return df, f"CSV({enc})"
            except:
                pass
        return None, "Fail"

    df_raw, msg = load_data(uploaded_file)

    if df_raw is not None:
        # 3. ë°ì´í„° ê°€ê³µ ë¡œì§
        try:
            # ì»¬ëŸ¼ëª… ì •ë¦¬
            df_raw.columns = df_raw.columns.astype(str).str.strip()

            # ë¶ˆí•„ìš”í•œ í–‰ ì œê±°
            if 'ê·œ ê²©' in df_raw.columns:
                df = df_raw[~df_raw['ê·œ ê²©'].astype(str).str.contains('í•©ê³„', na=False)].copy()
            else:
                df = df_raw.copy()

            # ì»¬ëŸ¼ ì°¾ê¸°
            company_col = 'ë°œ ì£¼ ì²˜' if 'ë°œ ì£¼ ì²˜' in df.columns else 'ë°œì£¼ì²˜'
            date_col = 'ë‚©í’ˆì¼'

            if company_col in df.columns and date_col in df.columns:
                # ë¹ˆ ê°’ ì±„ìš°ê¸° & ë‚ ì§œ ë³€í™˜
                df[date_col] = df[date_col].ffill()
                df[company_col] = df[company_col].ffill()
                df[date_col] = pd.to_datetime(df[date_col], errors='coerce').dt.strftime('%Y-%m-%d')

                # ì¬ì •ë ¬
                df_sorted = df.sort_values(by=[company_col, date_col])
                cols = [company_col, date_col] + [c for c in df_sorted.columns if c not in [company_col, date_col]]
                df_final = df_sorted[cols].set_index([company_col, date_col])

                # ë¯¸ë¦¬ë³´ê¸° ë³´ì—¬ì£¼ê¸°
                st.write("### ğŸ‘‡ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°")
                st.dataframe(df_final)

                # 4. ì—‘ì…€ ìŠ¤íƒ€ì¼ ì ìš© ë° ë‹¤ìš´ë¡œë“œ ì¤€ë¹„
                # ë©”ëª¨ë¦¬ ë‚´ì—ì„œ ì—‘ì…€ íŒŒì¼ ìƒì„± (io.BytesIO)
                output = io.BytesIO()

                # Pandas -> ExcelWriter (Openpyxl ì—”ì§„)
                with pd.ExcelWriter(output, engine='openpyxl') as writer:
                    df_final.to_excel(writer, sheet_name='Sheet1')

                # ìŠ¤íƒ€ì¼ ì ìš©ì„ ìœ„í•´ ë‹¤ì‹œ ë¡œë“œ (ë©”ëª¨ë¦¬ ìƒì—ì„œ)
                output.seek(0)
                wb = load_workbook(output)
                ws = wb.active

                # ìŠ¤íƒ€ì¼ ì •ì˜
                thin_border = Border(left=Side(style='thin'), right=Side(style='thin'),
                                     top=Side(style='thin'), bottom=Side(style='thin'))
                header_fill = PatternFill(start_color="D3D3D3", end_color="D3D3D3", fill_type="solid")
                center_align = Alignment(horizontal='center', vertical='center')

                # ìŠ¤íƒ€ì¼ ì ìš© ë£¨í”„
                for row in ws.iter_rows():
                    for cell in row:
                        cell.border = thin_border
                        cell.alignment = center_align
                        if cell.row == 1: # í—¤ë”
                            cell.fill = header_fill
                            cell.font = Font(bold=True)

                # ë³‘í•©ëœ ì…€ ì •ë ¬ ìˆ˜ì •
                for merge in list(ws.merged_cells):
                    ws[merge.coord.split(':')[0]].alignment = center_align

                # ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì •
                for col in ws.columns:
                    max_length = 0
                    column = col[0].column_letter
                    for cell in col:
                        try:
                            if len(str(cell.value)) > max_length:
                                max_length = len(str(cell.value))
                        except:
                            pass
                    ws.column_dimensions[column].width = (max_length + 2) * 1.2

                # ìµœì¢… ê²°ê³¼ë¬¼ ì €ì¥
                output = io.BytesIO()
                wb.save(output)
                output.seek(0)

                # 5. ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒì„±
                st.download_button(
                    label="ğŸ“¥ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
                    data=output,
                    file_name="ì •ë¦¬ëœ_ì‚¬ê¸‰ëª©ë¡.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )

            else:
                st.error(f"í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê°ì§€ëœ ì»¬ëŸ¼: {df.columns.tolist()})")

        except Exception as e:
            st.error(f"ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

    else:
        st.error("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")